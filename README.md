# 実行環境
- Ruby 2.7.3

「main.py」を実行することで，サーバを起動することができる．

# 特徴
## UI
- スレッド対応・テーマ(話題)ごとにスレッドを作成することができる．
- ajax通信・フロントエンドとサーバ(API)のデータのやり取りはajaxで行う．
- 分割表示・投稿数が多い場合に分割して表示する．

## Webサーバー
- rewrite(ステータスコード300番台)に対応している．
- 複数のファイル形式(js・css・html・json・png・jpg・svg・ico)に対応している．
- パスや拡張子に応じて対応するディレクトリからファイルを検索する．また対応するファイルがない場合も適切なステータスコード(404)を返す．
- ステータスコードが400番台，500番台の場合はエラーページを表示する．
- メソッドに応じて分岐を行い，適切なレスポンスを返す．
- リクエストヘッダのContent-Lengthを読み込んで，リクエストボディが適切かどうか判定をしている．
- その他HTTP/1.1の標準化(RFC2616)に一部対応している．

# 外部設計
## UI
実際に掲示板を表示するページはhtml・css・javascriptで作成し，データはajaxを用いてAPIから取得・追加を行う．

### スレッド作成・一覧
https://localhost:8080/

スレッドの一覧を作成日の新しい順に表示し、スレッド数が多い場合は分割で表示する。
またスレッドタイトルを入力してスレッドを作成すると、自動的に新規投稿画面に移動する。

### 新規投稿・投稿一覧
https://localhost:8080/th/xxx (xxxはスレッドID)

スレッド内の投稿内容を投稿日の新しい順に表示し、投稿数が多い場合は分割で表示する。
表示名(名前)・投稿内容を入力して「書き込む」をクリックすることで、新しく投稿を書き込むことができる。
各スレッドごとに異なるURLを設ける理由は、「別のスレッドに移動した際にブラウザの戻る機能が使えるようにする」「スレッドごとにブックマークをできるようにする」ためである。
画面上部の「スレッド一覧」をクリックすることで、スレッド一覧画面に戻ることができる。また「スレッド一覧」の左右の部分で前後のスレッドに移動することができる。

## API
データの取得・追加にはAPIを用いて、以下のエンドポイントからデータのやり取りを行うことができる。

### スレッド
https://localhost:8080/api/thread

GETの場合、スレッドの一覧を返す。
またパラメータにid(スレッドID)を付与することで、その前後のスレッドを取得することができる。
POSTの場合、スレッドの作成を行う。なお本文(request body)に「name(スレッド名)」が必要である。作成に成功した場合は、作成したデータを返す。

### 投稿内容
https://localhost:8080/api/article

GETの場合、すべての投稿内容を一覧で返す。
またパラメータにthread(スレッドID)を付与することで、対応するスレッドに投稿された内容のみ一覧で返す。
POSTの場合、投稿内容の追加を行う。なお本文に「スレッドID(thread\_id)・名前(name)・投稿内容(article)」が必要である。追加に成功した場合は、追加したデータを返す。

### レスポンス
APIのレスポンスはすべてJSONであり、その形式は以下の通りである。
- ok:(bool型) :データのやり取りに成功したかどうか
- data:(array型) (okがtrueの場合) :データ
- error:(string型) (okがfalseの場合) :エラー文・理由

## その他
- 画像の表示
- faviconの設定

# 内部設計

## Webサーバ
サーバで受け取ったリクエストに大して適切なレスポンスを返却することが必要である。大まかな部分は「main.py」に記載しているが、細かい部分においてリクエストを受け取り解釈を行う部分は「/src/request/」、レスポンスを返す部分は「/src/response/」に記載している。

### リクエスト部
受け取ったリクエストメッセージを「request line」「request header」「request body」に分割する。また「request line」は「method」「request url」「http version」に分割する。(RFC2616 5.1)

### メソッド
メソッドはRFC2616 5.1.1に定義されているもの以外であれば501を返す。またサポートしていないメソッドの場合は405を返し、レスポンスにAllowヘッダフィールドにてサポートしているメソッドを示している。(RFC2616 5.1.1)
またメソッドがHEADの場合はGETで取得したデータからresponse bodyを削除している。

### リクエストURL
リクエストURLはRFC2616 5.1.2における「abs_path」のみ対応している。abs_pathの形式はRFC2616 3.2で定義されているものであり、パス部(?より前の部分)はArray型で、パラメータ部(?より後の部分)はHash型で格納する。ここでパス部においてURLが「/」で終わる場合は「/index」であるものとみなしている。

### content-length
リクエストヘッダにContent-Lengthフィールドがない場合は411を返す。またContent-Lengthの値と「request body」が一致しない場合も400を返す。

### routing
リクエストURLに対応するファイルの内容を返す。このとき、拡張子が対応しているもの(html・css・jsなど)であれば、URLに対応する「/public/」直下のファイルの内容を返し、なければ404を返す。例えば、URLが「/sample/index.html」の場合は、「/public/sample/index.html」のデータを返す。

また拡張子がない場合は、拡張子「.rb」を付与して「/src/controller/」直下のファイルの内容を返し、なければ拡張子「.html」を付与して「/public/」直下でファイルを探し、それでもなければ404を返す。これは、ファイル名を省略した例えば「/sample/」の場合に、まず「src/controller/sample/index.rb」のデータを返し、なければ「/public/sample/index.html」のデータを返すようにするためである。

「/public/」直下のファイルの場合は、拡張子に応じてContent-Typeフィールドを付与している。また画像データに対応するため、Content-Typeがimageの場合にバイナリデータを返すようにしている。

### Controller
前述の通り、URLに拡張子がない場合は、「/src/controller/」直下のファイルの内容を返す。「/public/」直下のファイルの内容を返す場合と異なり、ファイル内に記載されている内容をそのまま返すのではなく、DB(後述)と接続してデータを表示したり、メソッドごとに処理を分岐することができる。

例えば、メソッドがGET(HEAD)の場合、該当するファイル(クラス)のインスタンスメソッドが「get」の部分の処理を行い、メソッドがPOSTの場合、「post」の部分の処理を行う。

### htaccess
「/public/」内のディレクトリにおいて、「.htaccess」のファイルを設置することでそのファイルが存在するフォルダへのアクセスがあった場合にrewriteを行うことができる。

「/sample/redirect/.htaccess」のファイル内に「R /sample/index.html 301」と記載をすると、「/sample/redirect/」にアクセスした際に「/sample/index.html」にステータスコード301でリダイレクトを行う。また数字を省略することでリダイレクトを行うことなく(URLを変えることなく)別ファイルの内容を表示することができる。

### エラーページ
ステータスコードが400以上の場合には、エラーページを表示する。エラーページの雛形は「/templete/error.html.erb」でステータスコードに応じて「/src/response/http-status-code.rb」に記載されている内容が表示される。

## DB
スレッド・投稿内容のデータは「/data/」フォルダに格納されている。

### CSV
データは「/data/csv/」直下のcsvに保存されており、ここのデータをもとに表示している。なお、csvファイルの1行目はヘッダーとしてカラム名を格納しており、実際のデータは2行目からである。

### model
csvファイルを直接操作するのではなく、「/data/model/」直下のファイルから上記csvファイルに対して操作するようにしている。これは、「/data/model.base.rb」でcsvデータの基本操作を共通化して、csvのファイル数が増えたときに使いまわしができるようにするためである。前述のController内のファイルはこのmodel内のファイルにアクセスしてデータのやりとりをしている。

## フロントエンド

### JavaScript
APIでデータのやり取りを行うajax通信を実現するために、JavaScriptのライブラリであるjQueryを使用している。またUNIXTimeから日付への変換や必須項目の空白時にエラーを出力するのもJavaScriptで実装している。

表示数が多い場合の分割表示もJacaScriptで実装している。ページごとにデータを取得すると、ページ移動ごとに待機時間が発生するので、最初にすべてのデータを取得して、ページの移動時には再度データを取得することがないようにしている。

### 投稿内容表示
各スレッドの投稿内容を閲覧するURLは「/th/xxx」であるが、実際に「/public/th/」直下にファイル(xxx)が存在する訳ではないので、「/th/.htaccess」ファイル内に「R /th/」を記載して、「/th/」直下のすべてのアクセスは「/th/index.html」の内容を表示するようにしている。